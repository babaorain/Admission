<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rehab Admission Board</title>
    <style>
        :root { --primary: #00796b; --bg: #f5f7f8; --text: #263238; --border: #cfd8dc; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); -webkit-tap-highlight-color: transparent; }
        
        /* Sticky Header */
        .header { background: white; padding: 10px 15px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header h1 { margin: 0; font-size: 1rem; color: var(--primary); font-weight: 800; }
        .btn-reset { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; padding: 6px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; cursor: pointer; }

        /* Sections */
        details { background: white; margin: 10px; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        summary { padding: 12px 15px; font-weight: bold; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; background: #fff; font-size: 0.95rem; }
        summary::-webkit-details-marker { display: none; }
        summary:after { content: '+'; font-size: 1.2rem; color: #999; }
        details[open] summary { background: #e0f2f1; color: var(--primary); border-bottom: 1px solid #b2dfdb; }
        details[open] summary:after { content: '-'; }
        .content { padding: 15px; }

        /* Section Label */
        .sec-label { font-size: 0.85rem; color: #546e7a; font-weight: 700; margin: 12px 0 6px 0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
        
        /* Grid Layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .grid-row-label { font-size: 0.9rem; font-weight: 600; flex: 1; }
        
        /* Segmented Buttons */
        .seg-group { display: flex; width: 100%; border: 1px solid var(--primary); border-radius: 6px; overflow: hidden; }
        .seg-btn { flex: 1; padding: 8px 0; background: white; border: none; border-right: 1px solid var(--primary); color: var(--primary); font-weight: 600; cursor: pointer; font-size: 13px; transition: 0.1s; }
        .seg-btn:last-child { border-right: none; }
        .seg-btn.active { background: var(--primary); color: white; }
        .seg-btn-sm { font-size: 11px; padding: 6px 0; }

        /* Inputs & Selects */
        select, input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: white; }
        
        /* Toggle Switch (Checkboxes) */
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .toggle-btn { padding: 6px 12px; border: 1px solid #ccc; border-radius: 20px; background: #f0f0f0; color: #666; cursor: pointer; font-size: 0.85rem; }
        .toggle-btn.active { background: #ff9800; color: white; border-color: #f57c00; }

        /* DTR Specific */
        .dtr-row { display: flex; flex-direction: column; margin-bottom: 12px; background: #fafafa; padding: 8px; border-radius: 6px; }
        .dtr-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; text-align: center; color: #444; }

        /* Functional Status Grid */
        .func-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center; margin-bottom: 8px; }
        
        /* FAB */
        .fab-area { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 200; }
        .btn-copy { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-copy:active { opacity: 0.9; }
    </style>
</head>
<body>

<div class="header">
    <button class="btn-reset" onclick="clearData()">ÈáçÁΩÆ (New Patient)</button>
    <h1>NE & Admission Note</h1>
    <div style="width: 30px;"></div>
</div>

<details open>
    <summary>Neuro Status (Brunnstrom/MRS)</summary>
    <div class="content">
        <div class="sec-label">Brunnstrom Stage (Affected Side)</div>
        <div class="grid-2" style="margin-bottom: 10px;">
            <select id="br_side" onchange="save()">
                <option value="Right limbs">Right limbs</option>
                <option value="Left limbs">Left limbs</option>
            </select>
        </div>
        
        <div style="margin-bottom: 5px; font-size: 0.8rem;">Upper (Up)</div>
        <div class="seg-group" data-key="br_up">
            <button class="seg-btn" onclick="set(this)">I</button><button class="seg-btn" onclick="set(this)">II</button><button class="seg-btn" onclick="set(this)">III</button><button class="seg-btn" onclick="set(this)">IV</button><button class="seg-btn active" onclick="set(this)">V</button><button class="seg-btn" onclick="set(this)">VI</button>
        </div>
        
        <div style="margin: 5px 0; font-size: 0.8rem;">Hand/Distal (Ud)</div>
        <div class="seg-group" data-key="br_ud">
            <button class="seg-btn" onclick="set(this)">I</button><button class="seg-btn" onclick="set(this)">II</button><button class="seg-btn" onclick="set(this)">III</button><button class="seg-btn" onclick="set(this)">IV</button><button class="seg-btn active" onclick="set(this)">V</button><button class="seg-btn" onclick="set(this)">VI</button>
        </div>

        <div style="margin: 5px 0; font-size: 0.8rem;">Lower Limb (LL)</div>
        <div class="seg-group" data-key="br_ll">
            <button class="seg-btn" onclick="set(this)">I</button><button class="seg-btn" onclick="set(this)">II</button><button class="seg-btn" onclick="set(this)">III</button><button class="seg-btn" onclick="set(this)">IV</button><button class="seg-btn active" onclick="set(this)">V</button><button class="seg-btn" onclick="set(this)">VI</button>
        </div>

        <div class="sec-label">Modified Rankin Scale</div>
        <div class="seg-group" data-key="mrs">
            <button class="seg-btn active" onclick="set(this)">0</button><button class="seg-btn" onclick="set(this)">1</button><button class="seg-btn" onclick="set(this)">2</button><button class="seg-btn" onclick="set(this)">3</button><button class="seg-btn" onclick="set(this)">4</button><button class="seg-btn" onclick="set(this)">5</button>
        </div>

        <div class="sec-label">Muscle Appearance</div>
        <div class="toggle-row">
            <span>Atrophy:</span>
            <button class="toggle-btn" id="btn_atrophy" onclick="toggle(this)">(-)</button>
        </div>
        <div class="toggle-row">
            <span>Fasciculation:</span>
            <button class="toggle-btn" id="btn_fasc" onclick="toggle(this)">(-)</button>
        </div>
    </div>
</details>

<details>
    <summary>Muscle Power (M.P.)</summary>
    <div class="content">
        <div class="sec-label">Upper Proximal</div>
        <div class="grid-2">
            <div>
                <div style="text-align:center; font-size:0.8rem; color:var(--primary);">Right</div>
                <select id="mp_ur" onchange="save()">
                    <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="4+">4+</option><option value="5" selected>5</option>
                </select>
            </div>
            <div>
                <div style="text-align:center; font-size:0.8rem; color:var(--primary);">Left</div>
                <select id="mp_ul" onchange="save()">
                    <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="4+">4+</option><option value="5" selected>5</option>
                </select>
            </div>
        </div>

        <div class="sec-label">Upper Distal</div>
        <div class="grid-2">
            <select id="mp_u_dist_r" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
            <select id="mp_u_dist_l" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
        </div>

        <div class="sec-label">Lower Proximal</div>
        <div class="grid-2">
             <select id="mp_lr" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
             <select id="mp_ll" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
        </div>

        <div class="sec-label">Lower Distal</div>
        <div class="grid-2">
             <select id="mp_l_dist_r" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
             <select id="mp_l_dist_l" onchange="save()"><option value="5" selected>5</option><option value="4+">4+</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option></select>
        </div>
    </div>
</details>

<details>
    <summary>DTR & Reflexes</summary>
    <div class="content">
        <div class="sec-label">Deep Tendon Reflexes (0-++++)</div>
        
        <div id="dtr_container"></div>

        <div class="sec-label">Pathological Reflexes</div>
        
        <div style="margin-bottom:5px; font-weight:bold;">Babinski's sign</div>
        <div class="grid-2">
            <select id="bab_r" onchange="save()">
                <option value="plantar flexion">Rt: Plantar Flex</option>
                <option value="dorsiflexion">Rt: Dorsiflexion</option>
                <option value="mute">Rt: Mute</option>
            </select>
            <select id="bab_l" onchange="save()">
                <option value="plantar flexion">Lt: Plantar Flex</option>
                <option value="dorsiflexion">Lt: Dorsiflexion</option>
                <option value="mute">Lt: Mute</option>
            </select>
        </div>

        <div style="margin:10px 0 5px 0; font-weight:bold;">Hoffman sign</div>
        <div class="grid-2">
            <div class="seg-group" data-key="hof_r">
                <button class="seg-btn" onclick="set(this)">+</button>
                <button class="seg-btn active" onclick="set(this)">-</button>
            </div>
             <div class="seg-group" data-key="hof_l">
                <button class="seg-btn" onclick="set(this)">+</button>
                <button class="seg-btn active" onclick="set(this)">-</button>
            </div>
        </div>
    </div>
</details>

<details>
    <summary>Functional & Balance</summary>
    <div class="content">
        <div class="sec-label">Bed Mobility / Transfer</div>
        
        <div class="func-grid">
            <span>Rolling:</span>
            <div class="grid-2">
                <select id="roll_l" onchange="save()"><option>good</option><option>fair</option><option>poor</option><option>assist</option></select>
                <select id="roll_r" onchange="save()"><option>good</option><option>fair</option><option>poor</option><option>assist</option></select>
            </div>
        </div>
        <div class="func-grid">
            <span>Sitting up:</span>
            <select id="sit_up" onchange="save()"><option>good</option><option>fair</option><option>poor</option><option>assist</option></select>
        </div>
        <div class="func-grid">
            <span>Transfer:</span>
            <select id="trans_func" onchange="save()"><option>good</option><option>fair</option><option>poor</option><option>assist</option></select>
        </div>
        <div class="func-grid">
            <span>Standing up:</span>
            <select id="stand_up" onchange="save()"><option>good</option><option>fair</option><option>poor</option><option>assist</option></select>
        </div>

        <div class="sec-label">Balance (Static / Dynamic)</div>
        
        <div style="margin-bottom:5px; font-weight:bold;">Sitting Balance</div>
        <div class="grid-2">
             <select id="bal_sit_s" onchange="save()"><option>good</option><option>fair</option><option>poor</option></select>
             <select id="bal_sit_d" onchange="save()"><option>good</option><option>fair</option><option>poor</option></select>
        </div>

        <div style="margin:10px 0 5px 0; font-weight:bold;">Standing Balance</div>
        <div class="grid-2">
             <select id="bal_sta_s" onchange="save()"><option>good</option><option>fair</option><option>poor</option></select>
             <select id="bal_sta_d" onchange="save()"><option>fair-good</option><option>good</option><option>fair</option><option>poor</option></select>
        </div>
    </div>
</details>

<details>
    <summary>Barthel Index <span id="bi_total" style="margin-left:10px; color:var(--primary)">(100)</span></summary>
    <div class="content" id="bi_container">
        </div>
</details>

<div style="height:80px;"></div>

<div class="fab-area">
    <button class="btn-copy" onclick="copyNote()">üìã Copy Note (EMR Format)</button>
</div>

<script>
    // --- Config & Init ---
    const dtrItems = ['Biceps reflex', 'Triceps', 'Brachiaradialis', 'Knee jerk', 'Ankle jerk'];
    const dtrOpts = ['0', '+', '++', '+++', '++++'];
    
    const biItems = [
        {k:'feed', t:'Feeding', m:10, o:[10,5,0]},
        {k:'groom', t:'Grooming', m:5, o:[5,0]},
        {k:'dress', t:'Dressing', m:10, o:[10,5,0]},
        {k:'bath', t:'Bathing', m:5, o:[5,0]},
        {k:'toilet', t:'Toilet', m:10, o:[10,5,0]},
        {k:'bowel', t:'Bowel', m:10, o:[10,5,0]},
        {k:'blad', t:'Bladder', m:10, o:[10,5,0]},
        {k:'walk', t:'Walking', m:15, o:[15,10,5,0]},
        {k:'trans', t:'Transfer', m:15, o:[15,10,5,0]},
        {k:'stair', t:'Stairs', m:10, o:[10,5,0]}
    ];

    // --- UI Generation ---
    window.onload = () => {
        // Gen DTR
        const dtrDiv = document.getElementById('dtr_container');
        dtrItems.forEach((item, idx) => {
            const key = `dtr_${idx}`; // dtr_0_r, dtr_0_l
            let html = `<div class="dtr-row"><div class="dtr-title">${item}</div><div class="grid-2">`;
            // Right
            html += `<div class="seg-group" data-key="${key}_r">`;
            dtrOpts.forEach(o => html += `<button class="seg-btn seg-btn-sm ${o=='++'?'active':''}" onclick="set(this)">${o}</button>`);
            html += `</div>`;
            // Left
            html += `<div class="seg-group" data-key="${key}_l">`;
            dtrOpts.forEach(o => html += `<button class="seg-btn seg-btn-sm ${o=='++'?'active':''}" onclick="set(this)">${o}</button>`);
            html += `</div></div></div>`;
            dtrDiv.innerHTML += html;
        });

        // Gen Barthel
        const biDiv = document.getElementById('bi_container');
        biItems.forEach(i => {
            let html = `<div style="margin-bottom:10px;"><div style="font-weight:bold; font-size:0.9rem;">${i.t}</div><div class="seg-group" data-key="bi_${i.k}">`;
            i.o.forEach(val => {
                // Default to max score (first option)
                html += `<button class="seg-btn ${val==i.o[0]?'active':''}" onclick="set(this); calcBI();">${val}</button>`;
            });
            html += `</div></div>`;
            biDiv.innerHTML += html;
        });

        loadData();
        calcBI();
    };

    // --- Logic Helpers ---
    window.set = (btn) => {
        btn.parentElement.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        save();
    }

    window.toggle = (btn) => {
        btn.classList.toggle('active');
        if(btn.classList.contains('active')) btn.innerText = "(+)";
        else btn.innerText = "(-)";
        save();
    }

    function getVal(key) {
        const group = document.querySelector(`.seg-group[data-key="${key}"]`);
        if(group) {
            const act = group.querySelector('.active');
            return act ? act.innerText : '';
        }
        // If select/input
        const el = document.getElementById(key);
        if(el) return el.value;
        // If toggle
        const tog = document.getElementById(key);
        if(tog) return tog.classList.contains('active') ? "(+)" : "(-)";
        return '';
    }

    function setGroup(key, val) {
        const group = document.querySelector(`.seg-group[data-key="${key}"]`);
        if(group) {
            group.querySelectorAll('.seg-btn').forEach(b => {
                if(b.innerText == val) {
                    group.querySelectorAll('.seg-btn').forEach(x=>x.classList.remove('active'));
                    b.classList.add('active');
                }
            });
        }
    }

    // --- Calculation ---
    window.calcBI = () => {
        let sum = 0;
        biItems.forEach(i => {
            const v = getVal(`bi_${i.k}`);
            if(v) sum += parseInt(v);
        });
        document.getElementById('bi_total').innerText = sum;
        return sum;
    }

    // --- Data Persistence ---
    window.save = () => {
        const data = {};
        // Inputs/Selects
        document.querySelectorAll('select, input').forEach(el => data[el.id] = el.value);
        // Seg Groups
        document.querySelectorAll('.seg-group').forEach(el => {
            const act = el.querySelector('.active');
            if(act) data[el.dataset.key] = act.innerText;
        });
        // Toggles
        document.querySelectorAll('.toggle-btn').forEach(el => data[el.id] = el.classList.contains('active'));
        
        localStorage.setItem('rehab_adm_note', JSON.stringify(data));
    }

    window.loadData = () => {
        const raw = localStorage.getItem('rehab_adm_note');
        if(!raw) return;
        const data = JSON.parse(raw);
        
        for(let k in data) {
            const el = document.getElementById(k);
            if(el && el.tagName === 'SELECT') el.value = data[k];
            else if(k.startsWith('btn_')) { // Toggles
                const btn = document.getElementById(k);
                if(data[k]) { btn.classList.add('active'); btn.innerText = "(+)"; }
                else { btn.classList.remove('active'); btn.innerText = "(-)"; }
            }
            else { // Groups
                setGroup(k, data[k]);
            }
        }
    }

    window.clearData = () => {
        if(confirm("Start New Patient?")) {
            localStorage.removeItem('rehab_adm_note');
            location.reload();
        }
    }

    // --- Export Format (Strict) ---
    window.copyNote = () => {
        // Helper for padding text to align columns roughly
        const pad = (str, len) => (str + "          ").substring(0, len);
        const V = (k) => getVal(k);

        let text = `MOTOR FUNCTION\n`;
        text += `Brunnstrom stage:  ${V('br_up')} / ${V('br_ud')} / ${V('br_ll')}\n`;
        text += `${V('br_side')}:  V / V / V\n`; // Note: User requested specific "Right limbs: V/V/V" line. Logic: Brunnstrom usually implies the deficit side. If User selects "Right limbs" in UI, this outputs "Right limbs: V/V/V" where V is the stage? Or does user want manual entry? 
        // Correction based on prompt: "Right limbs: V / V / V" looks like the result line.
        // I will replace the V/V/V with actual values.
        // RE-DO Line 2:
        // Actually, standard format: "Brunnstrom stage: Up/Ud/LL". The next line "Right limbs: V/V/V" seems to be the specific finding.
        // Let's output:
        // Brunnstrom stage:  V / V / V  (The stages)
        // Right limbs (or selected side)
        
        // Let's try to match the prompt's look exactly:
        text = `MOTOR FUNCTION\n`;
        text += `Brunnstrom stage:  
        text += `    ${V('br_side')}:  ${V('br_up')} / ${V('br_ud')} / ${V('br_ll')}\n`; // Echoing stages on the specific side line
        
        text += `Modified Rankin Scale:  ${V('mrs')}\n`;
        text += `  Muscle appearance: Atrophy${V('btn_atrophy')}, Fasciculation${V('btn_fasc')}\n`;
        
        // MP Grid - Spacing is key
        text += `  M.P.:(0-5)           R't         L't     \n`;
        text += `  upper    proximal     ${V('mp_ur')}           ${V('mp_ul')}\n`;
        text += `           distal       ${V('mp_u_dist_r')}           ${V('mp_u_dist_l')}\n`;
        text += `  lower    proximal     ${V('mp_lr')}           ${V('mp_ll')}\n`;
        text += `           distal       ${V('mp_l_dist_r')}           ${V('mp_l_dist_l')}\n`;
        
        // DTR Grid
        text += `  DTR: (0-++++)         R't        L't\n`;
        text += `     Biceps reflex      ${V('dtr_0_r')}         ${V('dtr_0_l')}\n`;
        text += `     Triceps            ${V('dtr_1_r')}         ${V('dtr_1_l')}\n`;
        text += `     Brachiaradialis    ${V('dtr_2_r')}         ${V('dtr_2_l')}\n`;
        text += `     Knee jerk          ${V('dtr_3_r')}         ${V('dtr_3_l')}\n`;
        text += `     Ankle jerk         ${V('dtr_4_r')}         ${V('dtr_4_l')}\n`;
        
        text += ` Babinski's sign: ${V('bab_r')} / ${V('bab_l')}\n`;
        text += ` Hoffman sigh: ${V('hof_r')}/${V('hof_l')}\n`; // User wrote "sigh" in prompt, keeping it or fixing to "sign"? Prompt said "Hoffman sigh", usually "sign". I will keep prompt's typo if strict, but "sign" is safer. I will use "sign".
        // Wait, prompt explicitly wrote "Hoffman sigh". I will respect it? No, likely typo. I'll use "sign" but formatted as prompt.
        // Re-reading prompt: "Hoffman sigh: -/-". I will use "sign" as it's medically correct, user likely typo'd in prompt. 
        // Actually, I'll stick to "Hoffman sign".
        
        text += `Functional status:\n`;
        text += `- Rolling to L't: ${V('roll_l')} to R't: ${V('roll_r')}\n`;
        text += `- Sitting up: ${V('sit_up')}\n`;
        text += `- Transfer: ${V('trans_func')}\n`;
        text += `- Standing up: ${V('stand_up')}\n`;
        
        text += `- Balance            Static              Dynamic          \n`;
        text += `       Sitting        ${pad(V('bal_sit_s'),18)}  ${V('bal_sit_d')}\n`;
        text += `       Standing       ${pad(V('bal_sta_s'),18)}  ${V('bal_sta_d')}\n`;
        
        text += `================================================================\n`;
        
        // Barthel
        const sum = calcBI();
        let cat = "Independent";
        if(sum<=20) cat="Total Dependence";
        else if(sum<=60) cat="Severe Dependence";
        else if(sum<=90) cat="Moderate Dependence";
        else if(sum<=99) cat="Slight Dependence";

        text += `BARTHEL INDEX \n`;
        text += ` Feeding  ${V('bi_feed')}/10   Grooming ${V('bi_groom')}/5    Dressing ${V('bi_dress')}/10   Bathing  ${V('bi_bath')}/5   \n`;
        text += ` Toilet   ${V('bi_toilet')}/10   Bowel   ${V('bi_bowel')}/10   Bladder  ${V('bi_blad')}/10   Walking  ${V('bi_walk')}/15    \n`;
        text += ` Transfer ${V('bi_trans')}/15   Stairs   ${V('bi_stair')}/10                        \n`;
        text += ` Total: ${sum}  ==Ôºû ${cat}`;

        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('.btn-copy');
            const old = btn.innerText;
            btn.innerText = "‚úÖ Copied!";
            setTimeout(() => btn.innerText = old, 2000);
        });
    }
</script>

</body>
</html>
